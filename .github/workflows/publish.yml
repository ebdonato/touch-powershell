name: Publish to PowerShell Gallery

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate module manifest
        shell: pwsh
        run: |
          $manifestPath = './touch.psd1'
          Test-ModuleManifest -Path $manifestPath
      
      - name: Publish module to PowerShell Gallery
        shell: pwsh
        env:
          NUGET_KEY: ${{ secrets.NUGET_KEY }}
        run: |
          # Create temp directory for module
          $moduleName = 'touch'
          $tempDir = '/tmp/psmodule'
          $moduleDir = "$tempDir/$moduleName"
          
          # Create module directory structure
          New-Item -ItemType Directory -Path $moduleDir -Force | Out-Null
          
          # Copy module files
          Copy-Item -Path './touch.psd1' -Destination "$moduleDir/" -Force
          Copy-Item -Path './touch.psm1' -Destination "$moduleDir/" -Force
          Copy-Item -Path './README.md' -Destination "$moduleDir/" -Force
          
          # Publish the module
          Publish-Module -Path $moduleDir `
            -NuGetApiKey $env:NUGET_KEY `
            -Repository PSGallery `
            -Verbose

name: Publish to PowerShell Gallery

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate module manifest
        shell: pwsh
        run: |
          $manifestPath = './touch/touch.psd1'
          Test-ModuleManifest -Path $manifestPath
      
      - name: Publish module to PowerShell Gallery
        shell: pwsh
        env:
          NUGET_KEY: ${{ secrets.NUGET_KEY }}
        run: |
          # Copy README to touch directory for packaging
          Copy-Item -Path './README.md' -Destination './touch/README.md' -Force
          
          # Publish the module from the touch directory
          Publish-Module -Path './touch' `
            -NuGetApiKey $env:NUGET_KEY `
            -Repository PSGallery `
            -Verbose
          
          # Clean up the copied README
          Remove-Item -Path './touch/README.md' -Force
